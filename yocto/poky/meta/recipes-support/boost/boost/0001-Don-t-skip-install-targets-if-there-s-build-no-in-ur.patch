From 78fd284a42caabe8815cb0870b46e5567872e75b Mon Sep 17 00:00:00 2001
From: Dmitry <grisumbras@gmail.com>
Date: Sat, 11 Dec 2021 16:58:23 +0300
Subject: [PATCH] Don't skip install targets if there's <build>no in ureqs
 (#113)

---
 src/tools/stage.jam      |  4 ++++
 test/install_build_no.py | 26 ++++++++++++++++++++++++++
 test/test_all.py         |  1 +
 3 files changed, 31 insertions(+)
 create mode 100755 test/install_build_no.py

Fixes install of boost fiber shared libraries which are missing in 1.78.0
but working in 1.79.0. Only kirkstone affected by this.

Upstream-Status: Backport

Signed-off-by: Mikko Rapeli <mikko.rapeli@bmw.de>

diff --git a/tools/build/src/tools/stage.jam b/tools/build/src/tools/stage.jam
index c5f02e3ba..325129dc8 100644
--- a/tools/build/src/tools/stage.jam
+++ b/tools/build/src/tools/stage.jam
@@ -478,6 +478,10 @@ class install-target-class : basic-target
         return [ sequence.unique $(result2) ] ;
     }
 
+    rule skip-from-usage-requirements ( )
+    {
+    }
+
     # Returns true iff 'type' is subtype of some element of 'types-to-include'.
     #
     local rule include-type ( type : types-to-include * )
diff --git a/tools/build/test/install_build_no.py b/tools/build/test/install_build_no.py
new file mode 100755
index 000000000..0ccf3c5cc
--- /dev/null
+++ b/tools/build/test/install_build_no.py
@@ -0,0 +1,26 @@
+#!/usr/bin/python
+
+# Copyright 2021 Dmitry Arkhipov (grisumbras@gmail.com)
+# Distributed under the Boost Software License, Version 1.0.
+# (See accompanying file LICENSE.txt or https://www.bfgroup.xyz/b2/LICENSE.txt)
+
+# Check that <build>no in usage-requirements of dependencies does not affect
+# install rule, i.e. a skipped installed target does not affect insallation of
+# other targets.
+
+import BoostBuild
+
+t = BoostBuild.Tester()
+
+t.write("a.cpp", "int main() {}\n")
+
+t.write("jamroot.jam", """
+make x : : maker : <build>no ;
+exe a : a.cpp ;
+install install : x a ;
+""")
+
+t.run_build_system()
+t.expect_addition("install/a.exe")
+
+t.cleanup()
diff --git a/tools/build/test/test_all.py b/tools/build/test/test_all.py
index b7ef5ad70..9ed729d01 100644
--- a/tools/build/test/test_all.py
+++ b/tools/build/test/test_all.py
@@ -250,6 +250,7 @@ tests = ["abs_workdir",
          "inherit_toolset",
          "inherited_dependency",
          "inline",
+         "install_build_no",
          "libjpeg",
          "liblzma",
          "libpng",
-- 
2.20.1

